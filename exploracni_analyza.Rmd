## Explorační analýza

-   Načtení dat
-   Standardizace dat (správné datové typy, tabulka jako `data.frame`, stack dat, odstranění NA)
-   Odstranění odlehlých pozorování (krabicový graf -\> původní hodnoty ponechat)
-   Analýza kvalitativních hodnot (absolutní a relativní četnost, sloupcový graf)
-   Analýza kvantitativních hodnot (seskupení podle kvalitativních hodnot, číselné charakteristiky [sum, var, sd...],\
    krabickové grafy, Q-Q grafy)
-   Posouzení modelování dat normálním rozdělením

*načtení knihoven, nastavení zaokrouhlení*

```{r}
library(readxl)
library(moments)
library(dplyr)
library(rstatix)
library(ggplot2)

options(OutDec = ".",
        digits = 7,
        pillar.sigfig = NULL)
```

### Načtení datového souboru

```{r}
#* typ zdrojových dat
#* csv [csv]
#* excel s jedním sheetem [excel]
#* excel s mnoha sheety [mexcel]
DATA_SOURCE_TYPE = "excel"

#* název datového souboru
DATA_FILE_NAME = "FPS_data"
#* jaký znak odděluje data v tabulce
SEPARATOR = ";"
#* přeskočení řádků na začátku tabulky
SKIP_ROWS = 0
#* jestli je první řádek tabulky název sloupce
FIRST_ROW_IS_HEADER = TRUE
#* stránky v excel tabulce ze kterých číst
EXCEL_SHEET_NAME = c("Vysledky mereni")

rm(data)

if (DATA_SOURCE_TYPE == "csv") {
  # DATA JSOU V JEDNOM CSV SOUBORU NA JEDNOM SHEETU
  data = read.csv2(file=paste("./data/", DATA_FILE_NAME, ".csv", sep=""), sep=SEPARATOR, skip=SKIP_ROWS, header=FIRST_ROW_IS_HEADER)
  data = as.data.frame(data)
}
if (DATA_SOURCE_TYPE == "excel") {
  # DATA JSOU V JEDNOM EXCEL SOUBORU NA JEDNOM SHEETU
  data = read_excel(paste("./data/", DATA_FILE_NAME, ".xlsx", sep=""), sheet=EXCEL_SHEET_NAME[1], skip=SKIP_ROWS)
  data = as.data.frame(data)
}
if (DATA_SOURCE_TYPE == "mexcel") {
  # DATA JSOU V JEDNOM EXCEL SOUBORU V JEDNOTLIVÝCH SHEETECH
  #* ruční načtení dat z jednotlivých sheetu
  data_A = readxl::read_excel(paste("./data/", DATA_FILE_NAME, ".xlsx", sep=""), sheet=EXCEL_SHEET_NAME[1], skip=SKIP_ROWS)
  data_B = readxl::read_excel(paste("./data/", DATA_FILE_NAME, ".xlsx", sep=""), sheet=EXCEL_SHEET_NAME[2], skip=SKIP_ROWS)
  data_C = readxl::read_excel(paste("./data/", DATA_FILE_NAME, ".xlsx", sep=""), sheet=EXCEL_SHEET_NAME[3], skip=SKIP_ROWS)
  data_D = readxl::read_excel(paste("./data/", DATA_FILE_NAME, ".xlsx", sep=""), sheet=EXCEL_SHEET_NAME[4], skip=SKIP_ROWS)
  #...atd...
  #...atd...
  
  data_A$typ = EXCEL_SHEET_NAME[1]
  data_B$typ = EXCEL_SHEET_NAME[2]
  data_C$typ = EXCEL_SHEET_NAME[3]
  data_D$typ = EXCEL_SHEET_NAME[4]
  #...atd...
  #...atd...
  
  data = rbind(data_A, data_B, data_C, data_D)
  data = as.data.frame(data)
  rm(data_A, data_B, data_C, data_D)
}
```

### Odstranění sloupců/řádků, změna názvu sloupců,

```{r}
#* odstranění řádků nebo sloupců
data = data[,-c(1)]

#* vytvoření nové tebulky ve smyslu vynechání řádků za nějaké podmínky
#data = data %>% filter(chem == "neprosel")

#* úprava názvů sloupců
colnames(data) = c("2080release", "2080patched", "3070release", "3070patched", "6800release", "6800patched", "7700release", "7700patched")
```

### Standardizace

```{r}
#* potřeba standardizace
FORMAT_NEEDED = TRUE

##* stack lze použít
##* poté je potřeba přejmenovat sloupce 
if (FORMAT_NEEDED) {
  data = reshape(data=data, 
                 direction="long",
                 # ktere sloupce beru z puvodni struktury, každá položka listu = 1 kategorie
                 varying=list(c("2080release", "3070release", "6800release", "7700release"),
                              c("2080patched", "3070patched", "6800patched", "7700patched")),
                 # jak se maji jmenovat nove sloupce s kvantitativnimi hodnotami
                 v.names=c("release", "patched"),
                 # jak se má jmenovat sloupec s kvalitativními hodnotami
                 timevar="typ",
                 # jak mají být kvalitativní hodnoty reprezentované
                 times=c("2080", "3070", "6800", "7700"))
}

#* odstranění vzniklého "id" sloupce
data$id = NULL

#* odstranění NA hodnot
data = na.omit(data)

#* změna sloupce kvalitativního znaku na faktor
data$typ = as.factor(data$typ)

#* změna sloupců kvantitativního znaku na numeric
data$release = as.numeric(data$release)
data$patched = as.numeric(data$patched)

#* generace vypocítaných sloupců
data = data %>% mutate(narust = patched - release)
```

### Odstranění odlehlých pozorování

```{r}
#* odstranění vzniklého "id" sloupce a generace nového
data$id = NULL
data$id = seq_along(data$typ)

#* výpis hodnot z boxplotu
#* v $out jsou uložena odlehlá pozorování detekována metodou vnitřních hradeb
#* v $group je info, ze které skupiny odlehlá pozorování jsou
boxplot(data$narust~data$typ, plot=FALSE)
boxplot(data$narust~data$typ)

#* funkce vyfiltruje z původního datového souboru odlehlá pozorování
outliners = data %>% group_by(typ) %>% identify_outliers(narust)
data$narust = ifelse(data$id %in% outliners$id, NA, data$narust)
rm(outliners)

#* odstranění NA hodnot po procesu odstranění odlehlých pozorování
data = na.omit(data)
```

### Analýza kvalitativních hodnot

```{r}
cetnosti = table(data$typ)
cetnosti
barplot(cetnosti)
```

### Analýza kvantitativních hodnot

```{r}
ciselne_charakteristiky = 
  data %>%
  group_by(typ) %>% 
  summarise(rozsah = length(na.omit(narust)),
            minimum = min(narust, na.rm=T),
            Q1 = quantile(narust, 0.25, na.rm=T),
            prumer = mean(narust, na.rm=T),
            median = median(narust, na.rm=T),
            Q3 = quantile(narust, 0.75, na.rm=T),
            maximum = max(narust, na.rm=T),
            rozptyl = var(narust, na.rm=T),
            smerodatna_odchylka = sd(narust, na.rm=T),
            variacni_koeficient = (100 * (smerodatna_odchylka / prumer)),
            sikmost = (moments::skewness(narust, na.rm=T)),
            spicatost = (moments::kurtosis(narust, na.rm=T) - 3))

t(ciselne_charakteristiky)
boxplot(data$narust~data$typ)
hist(data$narust, breaks=30)
```

### Reprezentace kvantitativních hodnot do grafů a jejich export

```{r}
col_1 = rgb( 33/255, 150/255, 243/255, alpha=0.3)
col_2 = rgb(255/255,  87/255,  34/255, alpha=0.3)
col_3 = rgb(156/255,  39/255, 176/255, alpha=0.3)
col_4 = rgb( 76/255, 175/255,  80/255, alpha=0.3)
```

```{r}
#* boxplot pro reporty
#png("plots/boxplot_narust_op_all.png", width=800, height=900, res=120)
boxplot(data$narust~data$typ,
  col=c(col_1, col_2, col_3, col_4),
  names=c("RTX 2080 Ti", "RTX 3070 Ti", "RX 6800 XT", "RX 7700 XT"),
  horizontal=TRUE,
  ylab="Typ GPU",
  xlab="Nárůst FPS",
  border="gray30",
  boxwex=0.75,
  pch=19
)
grid()
points(x=tapply(data$narust, data$typ, mean),
  y=1:4,
  pch=3,
  col="red",
  cex=1,
  lwd=1
)
```

```{r}
#* histogram pro reporty
#png("plots/histogram_narust_abs_all.png", width=800, height=600, res=120)
xmin = floor(min(data$narust, na.rm=TRUE) * 10)/10
xmax = ceiling(max(data$narust, na.rm=TRUE) * 10)/10
ggplot(data, aes(x=narust, fill=typ)) +
  geom_histogram(
    breaks=seq(xmin, xmax, by=0.25),
    color="black"
  ) +
  scale_fill_manual(
    values = c("2080"=col_1,"3070"=col_2,"6800"=col_3,"7700"=col_4)
  ) +
  facet_wrap(~typ,
    ncol=2,
    scales="fixed",
    labeller = as_labeller(c(
      "2080" = "RTX 2080 Ti",
      "3070" = "RTX 3070 Ti",
      "6800" = "RX 6800 XT",
      "7700" = "RX 7700 XT"
    ))
  ) +
  scale_x_continuous(
    breaks=seq(xmin, xmax, by=1),
    limits=c(xmin, xmax)
  ) +
  scale_y_continuous(
    breaks=scales::pretty_breaks(n=10)
  ) +
  labs(
    x="Nárůst FPS",
    y="Četnost",
  ) +
  theme_minimal() +
  theme(
    panel.grid.major=element_line(linetype="dotted"),
    legend.position="none"
  )
```

```{r}
#* hustota pravděpodobnosti
#png("plots/histogram_narust_rel_6800.png", width=800, height=600, res=120)
hist(narust_6800,
  breaks=20,
  col=col_2,
  border="black",
  main="Relativní četnost nárůstů FPS pro RX 6800 XT",
  xlab="Nárůst FPS",
  ylab="Hustota pravděpodobnosti",
  freq=FALSE
)
lines(density(narust_6800), col="#E63946", lwd=2)
xfit = seq(min(narust_6800), max(narust_6800), length=500)
yfit = dnorm(xfit, mean=mean(narust_6800), sd=sd(narust_6800))
lines(xfit, yfit, col="#1D3557", lwd=2)
legend("topright", 
  legend=c("Empirická hustota", "Teoretická norma"),
  fill=c("#E63946", "#1D3557")
)
grid(nx=NA, ny=NULL)
#dev.off()
```

```{r}
#* QQ-Grafy
#png("plots/qq_norm_3070.png", width=800, height=600, res=120)
qqnorm(narust_3070,
  pch=21,
  col="black",
  bg=col_1,
  cex=1.3,
  main="QQ-graf nárůstů FPS pro RTX 3070 Ti",
  xlab="Teoretické kvantily",
  ylab="Empirické kvantily"
)
qqline(narust_3070, col="#1D3557", lwd=1)
grid(nx=NA, ny=NULL)
#dev.off()
```

```{r}
#* QQ-Grafy (ggplot2)
png("plots/qq_norm_all.png", width=800, height=600, res=120)
mean_all = mean(data$narust, na.rm=TRUE)
sd_all = sd(data$narust, na.rm=TRUE)
xmin_data <- min(data$narust, na.rm = TRUE)
xmax_data <- max(data$narust, na.rm = TRUE)
theor_q <- qnorm(c(0.001, 0.999), mean = mean_all, sd = sd_all)
xmin <- min(xmin_data, theor_q[1])
xmax <- max(xmax_data, theor_q[2])
ggplot(data, aes(sample = narust, color = typ)) +
  stat_qq(
    distribution=qnorm, 
    dparams=list(mean=mean_all, sd=sd_all),
    size=1.6
  ) +
  stat_qq_line(
    distribution=qnorm,
    dparams=list(mean=mean_all, sd=sd_all),
    linetype="dashed", size=0.6
  ) +
  scale_color_manual(
    values = c("2080"=col_1,"3070"=col_2,"6800"=col_3,"7700"=col_4)
  ) +
  facet_wrap(~typ,
    ncol=2,
    scales="fixed",
    labeller=as_labeller(c(
     "2080"="RTX 2080 Ti",
     "3070"="RTX 3070 Ti",
     "6800"="RX 6800 XT",
     "7700"="RX 7700 XT"
   ))
  ) +
  coord_fixed(ratio=1, xlim=c(xmin, xmax), ylim=c(xmin, xmax)) +
  scale_x_continuous(breaks=seq(floor(xmin), ceiling(xmax), by=1)) +
  scale_y_continuous(breaks=seq(floor(xmin), ceiling(xmax), by=1)) +
  labs(
    x="Teoretické kvantily",
    y="Výběrové kvantily (Nárůst FPS)"
  ) +
  theme_minimal() +
  theme(
    panel.grid.major=element_line(linetype="dotted"),
    legend.position="none",
    axis.title.x=element_text(size=10),
    axis.title.y=element_text(size=10)
  )
```

### Tvorba dodatečných sloupců z informací k dispozici & extrakce do samostatných proměnných

```{r}

narust_3070 = data %>% filter(typ == "3070") %>% select(narust)
narust_3070 = na.omit(narust_3070$narust)
narust_6800 = data %>% filter(typ == "6800") %>% select(narust)
narust_6800 = na.omit(narust_6800$narust)
```

### Empirické ověření normality & aproximace hustoty pravděpodobnosti

```{r}
#* vykreslí histogram s relativní četností hustoty pravděpodobnosti
hist(narust_3070, freq=FALSE, breaks=20)

#* přidá odhad hustoty pravděpodobnosti jako křivku
lines(density(narust_6800), col="red", lwd=2)

#* vygeneruje hodnoty pro osu x & y a přidání křivku normálního rozdělení
xfit = seq(min(narust_6800), max(narust_6800), length=500)
yfit = dnorm(xfit, mean=mean(narust_6800), sd=sd(narust_6800))
lines(xfit, yfit, col="blue", lwd=2)

#* vykreslí QQ-grafy
qqnorm(narust_6800)
qqline(narust_6800)

#* sikmost, spicatost & pravidlo 3σ
sikmost = moments::skewness(narust_6800)
cat("sikmost: ", sikmost, "\n")
spicatost = moments::kurtosis(narust_6800) - 3
cat("spicatost: ", spicatost, "\n")
mean = mean(narust_6800)
sd = sd(narust_6800)
interval_95 <- c(mean - 2 * sd, mean + 2 * sd)

cat("95% interval: ", interval_95, "\n")
```


### Ověření normality (Shapirovým-Wilkovým testem)

```{r}
shapiro.test(narust_3070)$p.value
shapiro.test(narust_6800)$p.value
```

### Bodový a intervalový odhad střední hodnoty (Studentův t-test)

-   dolní/levostranný = greater
-   horní/pravostranný = less
-   oboustranný = two.sided

```{r}
#* intervalový odhad
#* pokud je v zadání `95% odhad`, znamená to, že hladina významnosti je 5% (zbytek)
#* do conf.level se píše těch 95%
t.test(narust_3070, alternative="greater", conf.level=0.95)
t.test(narust_6800, alternative="greater", conf.level=0.95)

#* bodový odhad
summary(narust_3070)
summary(narust_6800)
```

### Porovnání středních hodnot dvou typů

```{r}
# testování rozptylů
var.test(narust_6800, narust_3070, conf.level=0.95)

# testování intervalových odhadů
t.test(narust_6800, narust_3070, alternative = "greater", var.equal = TRUE)
```